<script>
    // 解决baidu地图有时候没有响应的问题，加载DOM完成后再加载地图
    // jquery风格的不好使，不知道为什么？只能使用javascript原生的
    //$(function(){
    window.onload = function(){
        var map = new BMap.Map("couponmap");
        var point = new BMap.Point(<%= compute_map_center_x(@products) %>, <%= compute_map_center_y(@products) %>);
        map.centerAndZoom(point,14);
        // 禁止鼠标滚动，用户体验更好
        //map.enableScrollWheelZoom();
        map.addControl(new BMap.NavigationControl());
        //map.addControl(new BMap.NavigationControl({type: BMAP_NAVIGATION_CONTROL_ZOOM}));

        function addMarkerContent(point, content){
            var marker = new BMap.Marker(point);
            map.addOverlay(marker);
            var infoWindow = new BMap.InfoWindow(content);
            marker.addEventListener("click", function(){this.openInfoWindow(infoWindow);});
        }

        <% @products.each do |product| %>
            var point = new BMap.Point(<%= product.pos_x %>, <%= product.pos_y %>);
            <% discount_string = "" %>
            <% case product.discount_type %>
            <% when DISCOUNT_TYPE_DISCOUNT %>
                <% discount_string = "直享<strong> #{product.discount} </strong>折" %>
            <% when DISCOUNT_TYPE_PRICE %>
                <% discount_string = "最低<strong> #{product.discount} </strong>元" %>
            <% when DISCOUNT_TYPE_NEW %>
                <% discount_string = "<strong> #{product.specific} </strong>" %>
            <% end %>
            var content = <%= '"'.html_safe %> \
                <%= "<div style='color:#666;line-height:20px;'>".html_safe %> \
                <%= "<h3 style='font-size:16px;'>吉林美优惠网</h3>".html_safe %> \
                <%= "#{product.title}<br/>".html_safe %> \
                <%= "优惠方式：#{discount_string}<br/>".html_safe %> \
                <%= "<a target='_blank' href='#{product_path(product)}'>详情 »</a>".html_safe %> \
                <%= '</div>"'.html_safe %>;
            addMarkerContent(point, content);
        <% end %>
    };
    //});
</script>
